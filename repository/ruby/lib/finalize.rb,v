head	1.4;
access;
symbols
	v1_6_7:1.3
	v1_6_6:1.3
	v1_6_5:1.3
	v1_6_4:1.3
	v1_7_1:1.3
	v1_6_4_preview4:1.3
	v1_6_4_preview3:1.3
	v1_6_4_preview2:1.3
	v1_6_4_preview1:1.3
	v1_6_3:1.3
	ruby_m17n:1.3.0.4
	ruby_1_6:1.3.0.2
	v1_6_2:1.3
	v1_6_1:1.3
	v1_6_0:1.2
	v1_4_6:1.2
	v1_4_5:1.2
	v1_4_4:1.2
	ruby_1_4_3:1.2
	ruby1_4_3:1.2
	v1_4_3:1.2
	v1_5_0:1.2
	ruby_1_4_3_pre1:1.2
	ruby_1_4:1.2.0.2
	v1_4_2:1.2
	v1_4_1:1.2
	v1_4_0:1.2
	v1_3_7:1.1.1.3.2.1
	v1_3_6_repack:1.1.1.3.2.1
	v1_3_6:1.1.1.3.2.1
	v1_3_5:1.1.1.3
	v1_2_6repack:1.1.1.2.2.7
	v1_3_4_990625:1.1.1.3
	v1_3_4_990624:1.1.1.3
	v1_2_6:1.1.1.2.2.7
	v1_3_4_990611:1.1.1.3
	v1_3_4_990531:1.1.1.3
	v1_3_3_990518:1.1.1.3
	v1_3_3_990513:1.1.1.3
	v1_3_3_990507:1.1.1.3
	v1_2_5:1.1.1.2.2.7
	v1_2_4:1.1.1.2.2.7
	v1_3_1_990225:1.1.1.3
	v1_3_1_990224:1.1.1.3
	v1_3_1_990215:1.1.1.3
	v1_3_1_990212:1.1.1.3
	v1_3_1_990210:1.1.1.3
	v1_3_1_:1.1.1.3
	v1_3_1_990209:1.1.1.3
	v1_3_1_990205:1.1.1.3
	v1_3_1_990203:1.1.1.3
	v1_3_1_990201:1.1.1.3
	v1_3_1"_990201:1.1.1.3
	v1_3_1_990128:1.1.1.3
	v1_3_1_990127:1.1.1.3
	v1_3_1_990126:1.1.1.3
	ruby_1_3:1.1.1.3.0.2
	v1_2_2:1.1.1.2.2.7
	RUBY_1_3:1.1.1.3
	v1_2_2_pr1:1.1.1.2.2.7
	v1_2_1repack:1.1.1.2.2.7
	v1_2_1:1.1.1.2.2.7
	v1_2_stable:1.1.1.2.2.7
	v1_1d1:1.1.1.2.2.7
	v1_1d0:1.1.1.2.2.7
	v1_1c9_1:1.1.1.2.2.7
	v1_1c9:1.1.1.2.2.7
	v1_1c8:1.1.1.2.2.7
	v1_1c7:1.1.1.2.2.7
	v1_1c6:1.1.1.2.2.7
	v1_1d-start:1.1.1.2.2.7
	v1_1c5:1.1.1.2.2.7
	v1_1dev:1.1.1.2.2.7.0.2
	v1_1c4:1.1.1.2.2.7
	v1_1c3:1.1.1.2.2.7
	v1_1c2:1.1.1.2.2.6
	v1_1c1:1.1.1.2.2.6
	v1_1c0:1.1.1.2.2.6
	v1_1b9_31:1.1.1.2.2.6
	v1_1b9_30:1.1.1.2.2.6
	v1_1b9_28:1.1.1.2.2.6
	v1_1b9_27:1.1.1.2.2.6
	v1_1b9_26:1.1.1.2.2.6
	r1_1b9_25:1.1.1.2.2.6
	r1_1b9_24:1.1.1.2.2.6
	v1_1b9_23:1.1.1.2.2.6
	v1_1b9_22:1.1.1.2.2.6
	v1_1b9_20:1.1.1.2.2.6
	v1_1b9_18:1.1.1.2.2.6
	v1_1b9_16:1.1.1.2.2.6
	v1_1b9_15:1.1.1.2.2.6
	v1_1b9_13:1.1.1.2.2.6
	v1_1b9_12:1.1.1.2.2.6
	v1_1b9_11:1.1.1.2.2.6
	v1_1b9_08:1.1.1.2.2.6
	v1_1b9_07:1.1.1.2.2.6
	r1_1b9:1.1.1.2.2.6
	v1_1b8:1.1.1.2.2.4
	v1_1b7:1.1.1.2.2.4
	v1_1b6:1.1.1.2.2.3
	v1_1r:1.1.1.2.0.2
	v1_1:1.1.1.2
	v1_0r:1.1.1.1.0.2
	v1_0:1.1.1.1
	RUBY:1.1.1;
locks; strict;
comment	@# @;
expand	@o@;


1.4
date	2002.08.29.09.08.18;	author matz;	state Exp;
branches;
next	1.3;

1.3
date	2000.09.07.06.59.43;	author matz;	state Exp;
branches;
next	1.2;

1.2
date	99.08.13.05.45.16;	author matz;	state Exp;
branches
	1.2.2.1;
next	1.1;

1.1
date	98.01.16.12.13.07;	author matz;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	98.01.16.12.13.07;	author matz;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	98.01.16.12.19.17;	author matz;	state Exp;
branches
	1.1.1.2.2.1;
next	1.1.1.3;

1.1.1.3
date	99.01.20.04.59.35;	author matz;	state Exp;
branches
	1.1.1.3.2.1;
next	;

1.1.1.3.2.1
date	99.07.22.10.37.25;	author matz;	state Exp;
branches;
next	;

1.1.1.2.2.1
date	98.01.16.12.36.04;	author matz;	state Exp;
branches;
next	1.1.1.2.2.2;

1.1.1.2.2.2
date	98.01.19.05.08.24;	author matz;	state Exp;
branches;
next	1.1.1.2.2.3;

1.1.1.2.2.3
date	98.01.19.05.09.38;	author matz;	state Exp;
branches;
next	1.1.1.2.2.4;

1.1.1.2.2.4
date	98.02.06.10.03.24;	author matz;	state Exp;
branches;
next	1.1.1.2.2.5;

1.1.1.2.2.5
date	98.02.27.05.40.01;	author matz;	state Exp;
branches;
next	1.1.1.2.2.6;

1.1.1.2.2.6
date	98.02.27.07.48.11;	author matz;	state Exp;
branches;
next	1.1.1.2.2.7;

1.1.1.2.2.7
date	98.08.27.03.55.42;	author matz;	state Exp;
branches;
next	;

1.2.2.1
date	2000.09.12.05.33.17;	author matz;	state Exp;
branches;
next	;


desc
@@


1.4
log
@* array.c (rb_ary_become): should not free ptr if it's shared.

* eval.c (rb_alias): prohibit making an alias named "allocate" if
  klass is a metaclass.

* string.c (rb_string_value_ptr): StringValuePtr() should never
  return NULL pointer.
@
text
@#
#   finalizer.rb - 
#   	$Release Version: 0.3$
#   	$Revision: 1.4 $
#   	$Date: 1998/02/27 05:34:33 $
#   	by Keiju ISHITSUKA
#
# --
#
#   Usage:
#
#   add(obj, dependant, method = :finalize, *opt)
#   add_dependency(obj, dependant, method = :finalize, *opt)
#	add dependency R_method(obj, dependant)
#
#   delete(obj_or_id, dependant, method = :finalize)
#   delete_dependency(obj_or_id, dependant, method = :finalize)
#	delete dependency R_method(obj, dependant)
#   delete_all_dependency(obj_or_id, dependant)
#	delete dependency R_*(obj, dependant)
#   delete_by_dependant(dependant, method = :finalize)
#	delete dependency R_method(*, dependant)
#   delete_all_by_dependant(dependant)
#	delete dependency R_*(*, dependant)
#   delete_all
#	delete all dependency R_*(*, *)
#
#   finalize(obj_or_id, dependant, method = :finalize)
#   finalize_dependency(obj_or_id, dependant, method = :finalize)
#	finalize the dependant connected by dependency R_method(obj, dependtant).
#   finalize_all_dependency(obj_or_id, dependant)
#	finalize all dependants connected by dependency R_*(obj, dependtant).
#   finalize_by_dependant(dependant, method = :finalize)
#	finalize the dependant connected by dependency R_method(*, dependtant).
#   finalize_all_by_dependant(dependant)
#	finalize all dependants connected by dependency R_*(*, dependant).
#   finalize_all
#	finalize all dependency registered to the Finalizer.
#
#   safe{..}
#	stop invoking Finalizer on GC.
#

module Finalizer
  RCS_ID='-$Id: finalize.rb,v 1.4 1998/02/27 05:34:33 keiju Exp keiju $-'

  class <<self
    # @@dependency: {id => [[dependant, method, *opt], ...], ...}

    # add dependency R_method(obj, dependant)
    def add_dependency(obj, dependant, method = :finalize, *opt)
      ObjectSpace.call_finalizer(obj)
      method = method.intern unless method.kind_of?(Integer)
      assoc = [dependant, method].concat(opt)
      if dep = @@dependency[obj.id]
	dep.push assoc
      else
	@@dependency[obj.id] = [assoc]
      end
    end
    alias add add_dependency

    # delete dependency R_method(obj, dependant)
    def delete_dependency(id, dependant, method = :finalize)
      id = id.id unless id.kind_of?(Integer)
      method = method.intern unless method.kind_of?(Integer)
      for assoc in @@dependency[id]
	assoc.delete_if do
	  |d, m, *o|
	  d == dependant && m == method
	end
	@@dependency.delete(id) if assoc.empty?
      end
    end
    alias delete delete_dependency

    # delete dependency R_*(obj, dependant)
    def delete_all_dependency(id, dependant)
      id = id.id unless id.kind_of?(Integer)
      method = method.intern unless method.kind_of?(Integer)
      for assoc in @@dependency[id]
	assoc.delete_if do
	  |d, m, *o|
	  d == dependant
	end
	@@dependency.delete(id) if assoc.empty?
      end
    end

    # delete dependency R_method(*, dependant)
    def delete_by_dependant(dependant, method = :finalize)
      method = method.intern unless method.kind_of?(Integer)
      for id in @@dependency.keys
	delete(id, dependant, method)
      end
    end

    # delete dependency R_*(*, dependant)
    def delete_all_by_dependant(dependant)
      for id in @@dependency.keys
	delete_all_dependency(id, dependant)
      end
    end

    # finalize the depandant connected by dependency R_method(obj, dependtant)
    def finalize_dependency(id, dependant, method = :finalize)
      id = id.id unless id.kind_of?(Integer)
      method = method.intern unless method.kind_of?(Integer)
      for assocs in @@dependency[id]
	assocs.delete_if do
	  |d, m, *o|
	  d.send(m, id, *o) if ret = d == dependant && m == method
	  ret
	end
	@@dependency.delete(id) if assoc.empty?
      end
    end
    alias finalize finalize_dependency

    # finalize all dependants connected by dependency R_*(obj, dependtant)
    def finalize_all_dependency(id, dependant)
      id = id.id unless id.kind_of?(Integer)
      method = method.intern unless method.kind_of?(Integer)
      for assoc in @@dependency[id]
	assoc.delete_if do
	  |d, m, *o|
	  d.send(m, id, *o) if ret = d == dependant
	end
	@@dependency.delete(id) if assoc.empty?
      end
    end

    # finalize the dependant connected by dependency R_method(*, dependtant)
    def finalize_by_dependant(dependant, method = :finalize)
      method = method.intern unless method.kind_of?(Integer)
      for id in @@dependency.keys
	finalize(id, dependant, method)
      end
    end

    # finalize all dependants connected by dependency R_*(*, dependtant)
    def finalize_all_by_dependant(dependant)
      for id in @@dependency.keys
	finalize_all_dependency(id, dependant)
      end
    end

    # finalize all dependants registered to the Finalizer.
    def finalize_all
      for id, assocs in @@dependency
	for dependant, method, *opt in assocs
	  dependant.send(method, id, *opt)
	end
	assocs.clear
      end
    end

    # method to call finalize_* safely.
    def safe
      old_status = Thread.critical
      Thread.critical = true
      ObjectSpace.remove_finalizer(@@proc)
      begin
	yield
      ensure
	ObjectSpace.add_finalizer(@@proc)
	Thread.critical = old_status
      end
    end

    private

    # registering function to ObjectSpace#add_finalizer
    def final_of(id)
      if assocs = @@dependency.delete(id)
	for dependant, method, *opt in assocs
	  dependant.send(method, id, *opt)
	end
      end
    end

  end
  @@dependency = Hash.new
  @@proc = proc{|id| final_of(id)}
  ObjectSpace.add_finalizer(@@proc)
end
@


1.3
log
@matz
@
text
@d46 14
a59 12
  
  # @@dependency: {id => [[dependant, method, *opt], ...], ...}
  
  # add dependency R_method(obj, dependant)
  def add_dependency(obj, dependant, method = :finalize, *opt)
    ObjectSpace.call_finalizer(obj)
    method = method.intern unless method.kind_of?(Integer)
    assoc = [dependant, method].concat(opt)
    if dep = @@dependency[obj.id]
      dep.push assoc
    else
      @@dependency[obj.id] = [assoc]
d61 26
a86 11
  end
  alias add add_dependency
  
  # delete dependency R_method(obj, dependant)
  def delete_dependency(id, dependant, method = :finalize)
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
    for assoc in @@dependency[id]
      assoc.delete_if do
	|d, m, *o|
	d == dependant && m == method
a87 1
      @@dependency.delete(id) if assoc.empty?
d89 6
a94 11
  end
  alias delete delete_dependency
  
  # delete dependency R_*(obj, dependant)
  def delete_all_dependency(id, dependant)
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
    for assoc in @@dependency[id]
      assoc.delete_if do
	|d, m, *o|
	d == dependant
a95 1
      @@dependency.delete(id) if assoc.empty?
d97 6
a102 7
  end
  
  # delete dependency R_method(*, dependant)
  def delete_by_dependant(dependant, method = :finalize)
    method = method.intern unless method.kind_of?(Integer)
    for id in @@dependency.keys
      delete(id, dependant, method)
d104 13
a116 6
  end
  
  # delete dependency R_*(*, dependant)
  def delete_all_by_dependant(dependant)
    for id in @@dependency.keys
      delete_all_dependency(id, dependant)
d118 12
a129 11
  end
  
  # finalize the depandant connected by dependency R_method(obj, dependtant)
  def finalize_dependency(id, dependant, method = :finalize)
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
    for assocs in @@dependency[id]
      assocs.delete_if do
	|d, m, *o|
	d.send(m, id, *o) if ret = d == dependant && m == method
	ret
a130 1
      @@dependency.delete(id) if assoc.empty?
d132 6
a137 11
  end
  alias finalize finalize_dependency
  
  # finalize all dependants connected by dependency R_*(obj, dependtant)
  def finalize_all_dependency(id, dependant)
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
    for assoc in @@dependency[id]
      assoc.delete_if do
	|d, m, *o|
	d.send(m, id, *o) if ret = d == dependant
a138 1
      @@dependency.delete(id) if assoc.empty?
d140 6
a145 7
  end
  
  # finalize the dependant connected by dependency R_method(*, dependtant)
  def finalize_by_dependant(dependant, method = :finalize)
    method = method.intern unless method.kind_of?(Integer)
    for id in @@dependency.keys
      finalize(id, dependant, method)
d147 9
a155 6
  end
  
  # finalize all dependants connected by dependency R_*(*, dependtant)
  def finalize_all_by_dependant(dependant)
    for id in @@dependency.keys
      finalize_all_dependency(id, dependant)
d157 11
a167 7
  end
  
  # finalize all dependants registered to the Finalizer.
  def finalize_all
    for id, assocs in @@dependency
      for dependant, method, *opt in assocs
	dependant.send(method, id, *opt)
a168 1
      assocs.clear
d170 9
a178 17
  end
  
  # method to call finalize_* safely.
  def safe
    old_status = Thread.critical
    Thread.critical = true
    ObjectSpace.remove_finalizer(@@proc)
    yield
    ObjectSpace.add_finalizer(@@proc)
    Thread.critical = old_status
  end
  
  # registering function to ObjectSpace#add_finalizer
  def final_of(id)
    if assocs = @@dependency.delete(id)
      for dependant, method, *opt in assocs
	dependant.send(method, id, *opt)
d181 1
a182 1
  
a185 22

  module_function :add
  module_function :add_dependency
  
  module_function :delete
  module_function :delete_dependency
  module_function :delete_all_dependency
  module_function :delete_by_dependant
  module_function :delete_all_by_dependant
  
  module_function :finalize
  module_function :finalize_dependency
  module_function :finalize_all_dependency
  module_function :finalize_by_dependant
  module_function :finalize_all_by_dependant
  module_function :finalize_all

  module_function :safe
  
  module_function :final_of
  private_class_method :final_of
  
@


1.2
log
@1.4.0
@
text
@d35 1
a35 1
#   fainalize_all_by_dependant(dependant)
d141 1
a141 1
  def fainalize_all_by_dependant(dependant)
d193 1
a193 1
  module_function :fainalize_all_by_dependant
@


1.2.2.1
log
@matz
@
text
@d35 1
a35 1
#   finalize_all_by_dependant(dependant)
d141 1
a141 1
  def finalize_all_by_dependant(dependant)
d193 1
a193 1
  module_function :finalize_all_by_dependant
@


1.1
log
@Initial revision
@
text
@d2 5
a6 5
#   finalize.rb - 
#   	$Release Version: $
#   	$Revision: 1.2 $
#   	$Date: 1997/07/25 02:43:00 $
#   	by Keiju ISHITSUKA(SHL Japan Inc.)
d14 1
a14 1
#	依存関係 R_method(obj, dependant) の追加
d18 1
a18 1
#	依存関係 R_method(obj, dependant) の削除
d20 1
a20 1
#	依存関係 R_*(obj, dependant) の削除
d22 1
a22 1
#	依存関係 R_method(*, dependant) の削除
d24 1
a24 1
#	依存関係 R_*(*, dependant) の削除
d26 1
a26 1
#	全ての依存関係の削除.
d30 1
a30 2
#	依存関連 R_method(obj, dependtant) で結ばれるdependantを
#	finalizeする.
d32 1
a32 1
#	依存関連 R_*(obj, dependtant) で結ばれるdependantをfinalizeする.
d34 1
a34 1
#	依存関連 R_method(*, dependtant) で結ばれるdependantをfinalizeする.
d36 1
a36 1
#	依存関連 R_*(*, dependtant) で結ばれるdependantをfinalizeする.
d38 1
a38 1
#	Finalizerに登録される全てのdependantをfinalizeする
d41 1
a41 2
#	gc時にFinalizerが起動するのを止める.
#
d45 1
a45 1
  RCS_ID='-$Header: /home/keiju/var/src/var.lib/ruby/RCS/finalize.rb,v 1.2 1997/07/25 02:43:00 keiju Exp keiju $-'
d49 1
a49 1
  # 依存関係 R_method(obj, dependant) の追加
d52 1
a52 1
    method = method.id unless method.kind_of?(Fixnum)
d62 1
a62 1
  # 依存関係 R_method(obj, dependant) の削除
d64 2
a65 2
    id = id.id unless id.kind_of?(Fixnum)
    method = method.id unless method.kind_of?(Fixnum)
d76 1
a76 1
  # 依存関係 R_*(obj, dependant) の削除
d78 2
a79 2
    id = id.id unless id.kind_of?(Fixnum)
    method = method.id unless method.kind_of?(Fixnum)
d89 1
a89 1
  # 依存関係 R_method(*, dependant) の削除
d91 1
a91 1
    method = method.id unless method.kind_of?(Fixnum)
d97 1
a97 1
  # 依存関係 R_*(*, dependant) の削除
d104 1
a104 2
  # 依存関連 R_method(obj, dependtant) で結ばれるdependantをfinalizeす
  # る.
d106 2
a107 2
    id = id.id unless id.kind_of?(Fixnum)
    method = method.id unless method.kind_of?(Fixnum)
d111 1
a111 1
	d.send(m, *o) if ret = d == dependant && m == method
d119 1
a119 1
  # 依存関連 R_*(obj, dependtant) で結ばれるdependantをfinalizeする.
d121 2
a122 2
    id = id.id unless id.kind_of?(Fixnum)
    method = method.id unless method.kind_of?(Fixnum)
d126 1
a126 1
	d.send(m, *o) if ret = d == dependant
d132 1
a132 1
  # 依存関連 R_method(*, dependtant) で結ばれるdependantをfinalizeする.
d134 1
a134 1
    method = method.id unless method.kind_of?(Fixnum)
d140 1
a140 1
  # 依存関連 R_*(*, dependtant) で結ばれるdependantをfinalizeする.
d147 1
a147 1
  # Finalizerに登録されている全てのdependantをfinalizeする
d157 1
a157 1
  # finalize_* を安全に呼び出すためのイテレータ
d160 1
a160 1
    Thread.critical = TRUE
d167 1
a167 1
  # ObjectSpace#add_finalizerへの登録関数
a201 1

@


1.1.1.1
log
@
@
text
@@


1.1.1.2
log
@*** empty log message ***
@
text
@d2 5
a6 5
#   finalizer.rb - 
#   	$Release Version: 0.2$
#   	$Revision: 1.3 $
#   	$Date: 1998/01/09 08:09:49 $
#   	by Keiju ISHITSUKA
d47 1
a47 1
  RCS_ID='-$Header: /home/keiju/var/src/var.lib/ruby/RCS/finalize.rb,v 1.3 1998/01/09 08:09:49 keiju Exp keiju $-'
d54 1
a54 1
    method = method.intern unless method.kind_of?(Integer)
d66 2
a67 2
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
d80 2
a81 2
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
d93 2
a94 2
    method = method.intern unless method.kind_of?(Integer)
    for id in Dependency.keys
d109 2
a110 2
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
d124 2
a125 2
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
d137 1
a137 1
    method = method.intern unless method.kind_of?(Integer)
@


1.1.1.3
log
@ruby 1.3 cycle
@
text
@d3 3
a5 3
#   	$Release Version: 0.3$
#   	$Revision: 1.4 $
#   	$Date: 1998/02/27 05:34:33 $
d14 1
a14 1
#	add dependency R_method(obj, dependant)
d18 1
a18 1
#	delete dependency R_method(obj, dependant)
d20 1
a20 1
#	delete dependency R_*(obj, dependant)
d22 1
a22 1
#	delete dependency R_method(*, dependant)
d24 1
a24 1
#	delete dependency R_*(*, dependant)
d26 1
a26 1
#	delete all dependency R_*(*, *)
d30 2
a31 1
#	finalize the dependant connected by dependency R_method(obj, dependtant).
d33 1
a33 1
#	finalize all dependants connected by dependency R_*(obj, dependtant).
d35 1
a35 1
#	finalize the dependant connected by dependency R_method(*, dependtant).
d37 1
a37 1
#	finalize all dependants connected by dependency R_*(*, dependant).
d39 1
a39 1
#	finalize all dependency registered to the Finalizer.
d42 2
a43 1
#	stop invoking Finalizer on GC.
d47 1
a47 1
  RCS_ID='-$Id: finalize.rb,v 1.4 1998/02/27 05:34:33 keiju Exp keiju $-'
d51 1
a51 1
  # add dependency R_method(obj, dependant)
d64 1
a64 1
  # delete dependency R_method(obj, dependant)
d78 1
a78 1
  # delete dependency R_*(obj, dependant)
d91 1
a91 1
  # delete dependency R_method(*, dependant)
d94 1
a94 1
    for id in @@dependency.keys
d99 1
a99 1
  # delete dependency R_*(*, dependant)
d106 2
a107 1
  # finalize the depandant connected by dependency R_method(obj, dependtant)
d114 1
a114 1
	d.send(m, id, *o) if ret = d == dependant && m == method
d122 1
a122 1
  # finalize all dependants connected by dependency R_*(obj, dependtant)
d129 1
a129 1
	d.send(m, id, *o) if ret = d == dependant
d135 1
a135 1
  # finalize the dependant connected by dependency R_method(*, dependtant)
d143 1
a143 1
  # finalize all dependants connected by dependency R_*(*, dependtant)
d150 1
a150 1
  # finalize all dependants registered to the Finalizer.
d160 1
a160 1
  # method to call finalize_* safely.
d170 1
a170 1
  # registering function to ObjectSpace#add_finalizer
d205 1
@


1.1.1.3.2.1
log
@backtrace may be Qnil
@
text
@d160 1
a160 1
    Thread.critical = true
@


1.1.1.2.2.1
log
@*** empty log message ***
@
text
@d4 2
a5 2
#   	$Revision: 1.1.1.2 $
#   	$Date: 1998/01/16 04:14:51 $
d47 1
a47 1
  RCS_ID='-$Header: /home/cvsroot/ruby/lib/finalize.rb,v 1.1.1.2 1998/01/16 04:14:51 matz Exp $-'
@


1.1.1.2.2.2
log
@Mon Jan 19 14:06:13 JST 1998
@
text
@d4 2
a5 2
#   	$Revision: 1.1.1.2.2.1 $
#   	$Date: 1998/01/16 12:36:04 $
d16 2
a17 2
#   delete(obj, dependant, method = :finalize)
#   delete_dependency(obj, dependant, method = :finalize)
d19 1
a19 1
#   delete_all_dependency(obj, dependant)
d28 2
a29 2
#   finalize(obj, dependant, method = :finalize)
#   finalize_dependency(obj, dependant, method = :finalize)
d32 1
a32 1
#   finalize_all_dependency(obj, dependant)
d47 3
a49 4
  RCS_ID='-$Header: /home/cvsroot/ruby/lib/finalize.rb,v 1.1.1.2.2.1 1998/01/16 12:36:04 matz Exp $-'

  # Dependency: {id => [[dependant, method, opt], ...], ...}
  Dependency = {}
d54 3
a56 2
    assoc = [dependant, method, opt]
    if dep = Dependency[obj.id]
d59 1
a59 1
      Dependency[obj.id] = [assoc]
d65 6
a70 4
  def delete_dependency(obj, dependant, method = :finalize)
    id = obj.id
    for assoc in Dependency[id]
      assoc.delete_if do |d,m,*o|
d73 1
a73 1
      Dependency.delete(id) if assoc.empty?
d79 6
a84 4
  def delete_all_dependency(obj, dependant)
    id = obj.id
    for assoc in Dependency[id]
      assoc.delete_if do |d,m,*o|
d87 1
a87 1
      Dependency.delete(id) if assoc.empty?
d90 1
a90 1

d98 1
a98 1

d101 1
a101 1
    for id in Dependency.keys
d105 2
a106 2

  # 依存関連 R_method(id, dependtant) で結ばれるdependantをfinalizeす
d109 7
a115 8
    for assocs in Dependency[id]
      assocs.delete_if do |d, m, *o|
	if d == dependant && m == method
	  d.send(m, *o)
	  true
	else
	  false
	end
d117 1
a117 1
      Dependency.delete(id) if assoc.empty?
d122 1
a122 1
  # 依存関連 R_*(id, dependtant) で結ばれるdependantをfinalizeする.
d124 6
a129 8
    for assoc in Dependency[id]
      assoc.delete_if do |d, m, *o|
	if d == dependant
	  d.send(m, *o)
	  true
	else
	  false
	end
d131 1
a131 1
      Dependency.delete(id) if assoc.empty?
d137 2
a138 1
    for id in Dependency.keys
d145 1
a145 1
    for id in Dependency.keys
d152 1
a152 1
    for id, assocs in Dependency
d162 3
a164 2
    old_status, Thread.critical = Thread.critical, true
    ObjectSpace.remove_finalizer(Proc)
d166 1
a166 1
    ObjectSpace.add_finalizer(Proc)
d172 1
a172 1
    if assocs = Dependency.delete(id)
d179 3
a181 2
  Proc = proc{|id| final_of(id)}
  ObjectSpace.add_finalizer(Proc)
d205 1
@


1.1.1.2.2.3
log
@*** empty log message ***
@
text
@d4 2
a5 2
#   	$Revision: 1.1.1.2.2.2 $
#   	$Date: 1998/01/19 05:08:24 $
d47 1
a47 1
  RCS_ID='-$Header: /home/cvsroot/ruby/lib/finalize.rb,v 1.1.1.2.2.2 1998/01/19 05:08:24 matz Exp $-'
d51 1
a51 1

d63 1
a63 1

d75 1
a75 1

d118 1
a118 1

d133 1
a133 1

d140 1
a140 1

d147 1
a147 1

d157 1
a157 1

d162 3
a164 6
    begin
      yield
    ensure
      ObjectSpace.add_finalizer(Proc)
      Thread.critical = old_status
    end
d166 1
a166 1

d175 1
a175 1

d181 1
a181 1

d187 1
a187 1

d196 1
a196 1

d199 1
a199 1

@


1.1.1.2.2.4
log
@-ko for keiju's files
@
text
@d4 2
a5 2
#   	$Revision: 1.3 $
#   	$Date: 1998/01/09 08:09:49 $
d47 1
a47 1
  RCS_ID='-$Header: /home/keiju/var/src/var.lib/ruby/RCS/finalize.rb,v 1.3 1998/01/09 08:09:49 keiju Exp keiju $-'
@


1.1.1.2.2.5
log
@*** empty log message ***
@
text
@d173 1
a173 1
      for dependant, method, opt in assocs
@


1.1.1.2.2.6
log
@finalize/mutex_m
@
text
@d3 3
a5 3
#   	$Release Version: 0.3$
#   	$Revision: 1.4 $
#   	$Date: 1998/02/27 05:34:33 $
d16 2
a17 2
#   delete(obj_or_id, dependant, method = :finalize)
#   delete_dependency(obj_or_id, dependant, method = :finalize)
d19 1
a19 1
#   delete_all_dependency(obj_or_id, dependant)
d28 2
a29 2
#   finalize(obj_or_id, dependant, method = :finalize)
#   finalize_dependency(obj_or_id, dependant, method = :finalize)
d32 1
a32 1
#   finalize_all_dependency(obj_or_id, dependant)
d47 5
a51 4
  RCS_ID='-$Id: finalize.rb,v 1.4 1998/02/27 05:34:33 keiju Exp keiju $-'
  
  # @@dependency: {id => [[dependant, method, *opt], ...], ...}
  
d55 2
a56 3
    method = method.intern unless method.kind_of?(Integer)
    assoc = [dependant, method].concat(opt)
    if dep = @@dependency[obj.id]
d59 1
a59 1
      @@dependency[obj.id] = [assoc]
d63 1
a63 1
  
d65 4
a68 6
  def delete_dependency(id, dependant, method = :finalize)
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
    for assoc in @@dependency[id]
      assoc.delete_if do
	|d, m, *o|
d71 1
a71 1
      @@dependency.delete(id) if assoc.empty?
d75 1
a75 1
  
d77 4
a80 6
  def delete_all_dependency(id, dependant)
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
    for assoc in @@dependency[id]
      assoc.delete_if do
	|d, m, *o|
d83 1
a83 1
      @@dependency.delete(id) if assoc.empty?
d86 1
a86 1
  
d90 1
a90 1
    for id in @@dependency.keys
d94 1
a94 1
  
d97 1
a97 1
    for id in @@dependency.keys
d101 2
a102 2
  
  # 依存関連 R_method(obj, dependtant) で結ばれるdependantをfinalizeす
d105 8
a112 7
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
    for assocs in @@dependency[id]
      assocs.delete_if do
	|d, m, *o|
	d.send(m, id, *o) if ret = d == dependant && m == method
	ret
d114 1
a114 1
      @@dependency.delete(id) if assoc.empty?
d118 2
a119 2
  
  # 依存関連 R_*(obj, dependtant) で結ばれるdependantをfinalizeする.
d121 8
a128 6
    id = id.id unless id.kind_of?(Integer)
    method = method.intern unless method.kind_of?(Integer)
    for assoc in @@dependency[id]
      assoc.delete_if do
	|d, m, *o|
	d.send(m, id, *o) if ret = d == dependant
d130 1
a130 1
      @@dependency.delete(id) if assoc.empty?
d133 1
a133 1
  
d136 1
a136 2
    method = method.intern unless method.kind_of?(Integer)
    for id in @@dependency.keys
d140 1
a140 1
  
d143 1
a143 1
    for id in @@dependency.keys
d147 1
a147 1
  
d150 1
a150 1
    for id, assocs in @@dependency
d157 1
a157 1
  
d160 8
a167 6
    old_status = Thread.critical
    Thread.critical = TRUE
    ObjectSpace.remove_finalizer(@@proc)
    yield
    ObjectSpace.add_finalizer(@@proc)
    Thread.critical = old_status
d169 1
a169 1
  
d172 2
a173 2
    if assocs = @@dependency.delete(id)
      for dependant, method, *opt in assocs
d178 3
a180 4
  
  @@dependency = Hash.new
  @@proc = proc{|id| final_of(id)}
  ObjectSpace.add_finalizer(@@proc)
d184 1
a184 1
  
d190 1
a190 1
  
d199 1
a199 1
  
d202 1
a202 1
  
a203 1

@


1.1.1.2.2.7
log
@1.1c3
@
text
@d14 1
a14 1
#	add dependency R_method(obj, dependant)
d18 1
a18 1
#	delete dependency R_method(obj, dependant)
d20 1
a20 1
#	delete dependency R_*(obj, dependant)
d22 1
a22 1
#	delete dependency R_method(*, dependant)
d24 1
a24 1
#	delete dependency R_*(*, dependant)
d26 1
a26 1
#	delete all dependency R_*(*, *)
d30 2
a31 1
#	finalize the dependant connected by dependency R_method(obj, dependtant).
d33 1
a33 1
#	finalize all dependants connected by dependency R_*(obj, dependtant).
d35 1
a35 1
#	finalize the dependant connected by dependency R_method(*, dependtant).
d37 1
a37 1
#	finalize all dependants connected by dependency R_*(*, dependant).
d39 1
a39 1
#	finalize all dependency registered to the Finalizer.
d42 2
a43 1
#	stop invoking Finalizer on GC.
d51 1
a51 1
  # add dependency R_method(obj, dependant)
d64 1
a64 1
  # delete dependency R_method(obj, dependant)
d78 1
a78 1
  # delete dependency R_*(obj, dependant)
d91 1
a91 1
  # delete dependency R_method(*, dependant)
d99 1
a99 1
  # delete dependency R_*(*, dependant)
d106 2
a107 1
  # finalize the depandant connected by dependency R_method(obj, dependtant)
d122 1
a122 1
  # finalize all dependants connected by dependency R_*(obj, dependtant)
d135 1
a135 1
  # finalize the dependant connected by dependency R_method(*, dependtant)
d143 1
a143 1
  # finalize all dependants connected by dependency R_*(*, dependtant)
d150 1
a150 1
  # finalize all dependants registered to the Finalizer.
d160 1
a160 1
  # method to call finalize_* safely.
d170 1
a170 1
  # registering function to ObjectSpace#add_finalizer
d205 1
@
